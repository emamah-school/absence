// بيانات التطبيق
let records = JSON.parse(localStorage.getItem('absenceRecords')) || [];
let currentRecord = null;
let scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; // استبدل برابطك

// عناصر DOM
const absenceForm = document.getElementById('absenceForm');
const whatsappSection = document.getElementById('whatsappSection');
const messagePreview = document.getElementById('messagePreview');
const sendWhatsApp = document.getElementById('sendWhatsApp');
const todayRecords = document.getElementById('todayRecords');
const allRecords = document.getElementById('allRecords');
const currentDateElement = document.getElementById('currentDate');
const todayAbsenceElement = document.getElementById('todayAbsence');
const todayTasyeebElement = document.getElementById('todayTasyeeb');
const todayHuroobElement = document.getElementById('todayHuroob');
const totalReviewedElement = document.getElementById('totalReviewed');
const dateInput = document.getElementById('date');
const dayInput = document.getElementById('day');
const classSelect = document.getElementById('class');
const sectionSelect = document.getElementById('section');
const studentSelect = document.getElementById('studentName');
const parentPhoneInput = document.getElementById('parentPhone');
const availablePhonesInput = document.getElementById('availablePhones');

// تهيئة التاريخ الحالي
function initializeDate() {
    const now = new Date();
    
    // تحديث التاريخ الميلادي في العنوان
    const gregorianOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    currentDateElement.textContent = now.toLocaleDateString('ar-SA', gregorianOptions);
    
    // تعيين التاريخ الحالي في حقل التاريخ
    dateInput.valueAsDate = now;
    
    // تعيين اليوم الحالي
    updateDayFromDate(now);
}

// تحديث اليوم بناءً على التاريخ المحدد
function updateDayFromDate(date) {
    const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    dayInput.value = days[date.getDay()];
}

// جلب الشعب من Google Sheets
async function loadSections() {
    const selectedClass = classSelect.value;
    sectionSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    sectionSelect.disabled = true;
    studentSelect.disabled = true;
    studentSelect.innerHTML = '<option value="">اختر الشعبة أولاً</option>';
    parentPhoneInput.value = '';
    
    if (!selectedClass) {
        sectionSelect.innerHTML = '<option value="">اختر الصف أولاً</option>';
        return;
    }
    
    try {
        const response = await fetch(`${scriptUrl}?action=getSections&grade=${selectedClass}`);
        const data = await response.json();
        
        sectionSelect.innerHTML = '<option value="">اختر الشعبة</option>';
        
        if (data.sections && data.sections.length > 0) {
            data.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            sectionSelect.disabled = false;
        } else {
            sectionSelect.innerHTML = '<option value="">لا توجد شعب</option>';
        }
    } catch (error) {
        console.error('Error loading sections:', error);
        sectionSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
    }
}

// جلب الطالبات من Google Sheets
async function loadStudents() {
    const selectedClass = classSelect.value;
    const selectedSection = sectionSelect.value;
    
    studentSelect.innerHTML = '<option value="">جاري التحميل...</option>';
    studentSelect.disabled = true;
    parentPhoneInput.value = '';
    
    if (!selectedSection) {
        studentSelect.innerHTML = '<option value="">اختر الشعبة أولاً</option>';
        return;
    }
    
    try {
        const response = await fetch(`${scriptUrl}?action=getStudents&class=${selectedClass}&section=${selectedSection}`);
        const data = await response.json();
        
        studentSelect.innerHTML = '<option value="">اختر الطالبة</option>';
        
        if (data.students && data.students.length > 0) {
            data.students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                option.setAttribute('data-phone', data.phones[index] || '');
                studentSelect.appendChild(option);
            });
            studentSelect.disabled = false;
            
            // حفظ قائمة الهواتف للحقل المخفي
            availablePhonesInput.value = JSON.stringify(data.phones);
        } else {
            studentSelect.innerHTML = '<option value="">لا توجد طالبات</option>';
        }
    } catch (error) {
        console.error('Error loading students:', error);
        studentSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
    }
}

// تحديث رقم هاتف ولي الأمر عند اختيار الطالبة
function updateParentPhone() {
    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
    const phone = selectedOption.getAttribute('data-phone') || '';
    parentPhoneInput.value = phone;
}

// حفظ السجلات في localStorage
function saveRecords() {
    localStorage.setItem('absenceRecords', JSON.stringify(records));
    updateStats();
    displayRecords();
}

// تحديث الإحصائيات
function updateStats() {
    const today = new Date().toISOString().split('T')[0];
    
    const todayRecords = records.filter(record => record.date === today);
    const todayAbsence = todayRecords.filter(record => record.status === 'غياب').length;
    const todayTasyeeb = todayRecords.filter(record => record.status === 'تسيب').length;
    const todayHuroob = todayRecords.filter(record => record.status === 'هروب').length;
    const totalReviewed = records.filter(record => record.reviewed).length;
    
    todayAbsenceElement.textContent = todayAbsence;
    todayTasyeebElement.textContent = todayTasyeeb;
    todayHuroobElement.textContent = todayHuroob;
    totalReviewedElement.textContent = totalReviewed;
}

// عرض السجلات
function displayRecords() {
    const today = new Date().toISOString().split('T')[0];
    
    // سجلات اليوم
    const todayRecordsData = records.filter(record => record.date === today);
    todayRecords.innerHTML = '';
    
    if (todayRecordsData.length === 0) {
        todayRecords.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد سجلات لهذا اليوم</td></tr>';
    } else {
        todayRecordsData.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${record.studentName}</td>
                <td>${record.class}</td>
                <td><span class="status-badge status-${record.status}">${record.status}</span></td>
                <td>${record.time}</td>
                <td>
                    <i class="fas fa-whatsapp whatsapp-link" onclick="prepareWhatsAppMessage('${record.id}')"></i>
                    ${record.reviewed ? '<i class="fas fa-check-circle reviewed-check"></i>' : '<i class="fas fa-times" style="color: #ccc;"></i>'}
                </td>
            `;
            todayRecords.appendChild(row);
        });
    }
    
    // جميع السجلات
    allRecords.innerHTML = '';
    
    if (records.length === 0) {
        allRecords.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد سجلات</td></tr>';
    } else {
        records.slice().reverse().forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.studentName}</td>
                <td>${record.class}</td>
                <td><span class="status-badge status-${record.status}">${record.status}</span></td>
                <td>${record.reviewed ? '<i class="fas fa-check-circle reviewed-check"></i>' : '<i class="fas fa-times" style="color: #ccc;"></i>'}</td>
                <td>
                    <i class="fas fa-whatsapp whatsapp-link" onclick="prepareWhatsAppMessage('${record.id}')"></i>
                    <i class="fas fa-edit" style="color: #4361ee; margin-right: 10px; cursor: pointer;" onclick="markAsReviewed('${record.id}')"></i>
                </td>
            `;
            allRecords.appendChild(row);
        });
    }
}

// تحضير رسالة واتساب
function prepareWhatsAppMessage(recordId) {
    const record = records.find(r => r.id === recordId);
    if (!record) return;
    
    currentRecord = record;
    
    const message = `نفيدكم بأن ابنتكم الطالبة ${record.studentName} المقيدة بالصف ${record.class} قد ${record.status} لأسباب لا نعلمها. - إدارة المدرسة`;
    
    messagePreview.textContent = message;
    whatsappSection.style.display = 'block';
    
    // تمرير البيانات إلى زر واتساب
    sendWhatsApp.onclick = function() {
        sendWhatsAppMessage(record.parentPhone, message);
    };
    
    // التمرير إلى قسم الواتساب
    whatsappSection.scrollIntoView({ behavior: 'smooth' });
}

// إرسال رسالة واتساب
function sendWhatsAppMessage(phone, message) {
    // إضافة رمز الدولة السعودية إذا لم يكن موجودًا
    let formattedPhone = phone.startsWith('+') ? phone : `+966${phone}`;
    
    // إزالة أي مسافات أو أحرف غير رقمية
    formattedPhone = formattedPhone.replace(/\D/g, '');
    
    // ترميز النص للرابط
    const encodedMessage = encodeURIComponent(message);
    
    // استخدام رابط الواتساب الصحيح
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`;
    
    // فتح نافذة جديدة للواتساب
    window.open(whatsappUrl, '_blank');
}

// تعليم السجل كمُراجع
function markAsReviewed(id) {
    const record = records.find(r => r.id === id);
    if (record) {
        record.reviewed = true;
        saveRecords();
    }
}

// معالجة إرسال النموذج
absenceForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const record = {
        id: Date.now().toString(),
        date: document.getElementById('date').value,
        day: document.getElementById('day').value,
        class: document.getElementById('section').value, // استخدام الشعبة كصف
        studentName: document.getElementById('studentName').value,
        parentPhone: document.getElementById('parentPhone').value,
        status: document.getElementById('status').value,
        time: new Date().toLocaleTimeString('ar-SA'),
        reviewed: false
    };
    
    records.push(record);
    saveRecords();
    
    // تحضير رسالة الواتساب للسجل الجديد
    prepareWhatsAppMessage(record.id);
    
    // إعادة تعيين النموذج
    absenceForm.reset();
    initializeDate();
    
    // إعادة تعيين القوائم المنسدلة
    sectionSelect.innerHTML = '<option value="">اختر الشعبة أولاً</option>';
    sectionSelect.disabled = true;
    studentSelect.innerHTML = '<option value="">اختر الطالبة أولاً</option>';
    studentSelect.disabled = true;
});

// تحديث اليوم عند تغيير التاريخ
dateInput.addEventListener('change', function() {
    const selectedDate = new Date(this.value);
    updateDayFromDate(selectedDate);
});

// تبديل التبويبات
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // إزالة النشاط من جميع التبويبات والمحتويات
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // إضافة النشاط للتبويب والمحتوى المحدد
        this.classList.add('active');
        document.getElementById(`${tabId}Tab`).classList.add('active');
    });
});

// تهيئة التطبيق عند التحميل
document.addEventListener('DOMContentLoaded', function() {
    initializeDate();
    updateStats();
    displayRecords();
    
    // تعيين رابط السكربت الفعلي (استبدل YOUR_SCRIPT_ID برابطك)
    scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
});
</script>
</body>
</html>


